<!DOCTYPE html>
<html lang="en">
<head>
  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3WV4JB97VY"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-3WV4JB97VY', { send_page_view: true /* ,debug_mode: true */ });
  </script>

  <!-- Plausible Analytics -->
  <script defer data-domain="cropmypic.vercel.app" src="https://plausible.io/js/script.js"></script>

  <!-- Google AdSense loader (global). We will only push ads for Free users -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8562223178556235" crossorigin="anonymous"></script>

  <!-- Stripe.js -->
  <script src="https://js.stripe.com/v3"></script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CropMyPic — Free Online Image Resizer & Compressor</title>

  <!-- SEO meta -->
  <meta name="description" content="Crop, resize & compress images for Amazon, Etsy, Shopify, Instagram, TikTok, YouTube. Free online tool with presets." />
  <meta name="keywords" content="image resizer, image compressor, amazon photo size, etsy thumbnail, shopify banner, instagram story size, tiktok video cover, youtube thumbnail" />

  <!-- Open Graph -->
  <meta property="og:title" content="CropMyPic — Free Online Image Resizer & Compressor" />
  <meta property="og:description" content="Resize & compress images instantly with presets for Amazon, Etsy, Shopify, Instagram, TikTok, and YouTube." />
  <meta property="og:url" content="https://cropmypic.vercel.app/" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://cropmypic.vercel.app/og-preview.png" />

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="CropMyPic — Free Online Image Resizer & Compressor" />
  <meta name="twitter:description" content="Resize & compress images instantly for Amazon, Etsy, Shopify, Instagram, TikTok, YouTube." />
  <meta name="twitter:image" content="https://cropmypic.vercel.app/og-preview.png" />

  <!-- Search Console verification -->
  <meta name="google-site-verification" content="2doTA3Wch0qlLgmHJVYz54JqQkLcLPwwt6VpjbtAiXU" />

  <!-- Favicons / Apple / PWA -->
  <link rel="icon" href="/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="/favicon-16.png" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" href="/apple-touch-180.png" sizes="180x180">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#111827">

  <!-- Tailwind + JSZip + Cropper -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <link  href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet">
  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
  
  <style>
    /* Additional styles for better UI */
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .btn-loading {
      position: relative;
      color: transparent;
    }
    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin: -10px 0 0 -10px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s ease infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-white text-gray-900">
  <header class="sticky top-0 z-10 bg-white/70 backdrop-blur border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="text-xl font-bold">Crop<span class="text-indigo-600">MyPic</span></a>
      <nav class="hidden sm:flex gap-6 text-sm">
        <a href="#sellers" class="hover:text-indigo-600">For Sellers</a>
        <a href="#creators" class="hover:text-indigo-600">For Creators</a>
        <a href="#pricing" class="hover:text-indigo-600">Pricing</a>
        <a href="#faq" class="hover:text-indigo-600">FAQ</a>
        <a href="/blog/index.html" class="hover:text-indigo-600">Blog</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    <section class="text-center mb-10">
      <h1 class="text-3xl sm:text-5xl font-extrabold leading-tight">
        Free Online Image <span class="text-indigo-600">Cropper</span>,
        <span class="text-indigo-600">Resizer</span> & <span class="text-indigo-600">Compressor</span>
      </h1>
      <p class="mt-3 text-gray-600 max-w-2xl mx-auto">
        Perfect sizes for <strong>Amazon, Etsy, Shopify</strong> and
        <strong>Instagram, TikTok, YouTube</strong>. No signup. Works in your browser.
      </p>
      <p class="text-xs text-gray-500 mt-2">
        Bonus: generate app icons for iOS, iPadOS, watchOS, Android (LDPI–XXXHDPI) and favicons/PWA icons (16–512 px).
      </p>
    </section>

    <!-- App grid -->
    <section class="grid md:grid-cols-3 gap-6 items-start">
      <!-- Left: uploader + controls -->
      <div class="md:col-span-2">
        <!-- Dropzone -->
        <div id="dropzone" class="border-2 border-dashed border-gray-200 rounded-2xl p-6 text-center hover:border-indigo-300 transition cursor-pointer">
          <input id="fileInput" type="file" accept="image/*" multiple class="hidden" />
          <div class="py-8">
            <p class="text-lg font-semibold">Drag & drop images here</p>
            <p class="text-sm text-gray-500">or click to choose files (max 5 images, ≤ 10MB each on free tier)</p>
            <button id="browseBtn" class="mt-4 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Choose Files</button>
          </div>
        </div>

        <!-- Controls -->
        <div class="mt-4 grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium mb-1">Preset</label>
            <select id="preset" class="w-full border rounded-xl p-2">
              <!-- Sellers -->
              <optgroup label="For Sellers (Amazon/Etsy/Shopify)"></optgroup>
              <option value="2000x2000">Amazon Product — 2000×2000</option>
              <option value="1600x1600">Etsy Square — 1600×1600</option>
              <option value="1200x400">Shopify Banner — 1200×400</option>

              <!-- Creators -->
              <optgroup label="For Creators (Instagram/TikTok/YT)"></optgroup>
              <option value="1080x1080">Instagram Post — 1080×1080</option>
              <option value="1080x1920">Instagram/TikTok Story — 1080×1920</option>
              <option value="1280x720">YouTube Thumbnail — 1280×720</option>

              <!-- App Devs: iOS/iPadOS -->
              <optgroup label="App Icons — iOS / iPadOS"></optgroup>
              <option value="20x20">iOS — 20×20</option>
              <option value="29x29">iOS — 29×29</option>
              <option value="40x40">iOS — 40×40</option>
              <option value="50x50">iOS — 50×50</option>
              <option value="57x57">iOS — 57×57</option>
              <option value="58x58">iOS — 58×58</option>
              <option value="72x72">iOS — 72×72</option>
              <option value="76x76">iOS — 76×76</option>
              <option value="80x80">iOS — 80×80</option>
              <option value="87x87">iOS — 87×87</option>
              <option value="100x100">iOS — 100×100</option>
              <option value="114x114">iOS — 114×114</option>
              <option value="120x120">iOS — 120×120</option>
              <option value="144x144">iOS — 144×144</option>
              <option value="152x152">iOS — 152×152</option>
              <option value="167x167">iPad — 167×167</option>
              <option value="180x180">iPhone — 180×180</option>
              <option value="512x512">iOS — 512×512</option>
              <option value="1024x1024">App Store — 1024×1024</option>

              <!-- watchOS -->
              <optgroup label="App Icons — watchOS"></optgroup>
              <option value="48x48">watchOS — 48×48</option>
              <option value="55x55">watchOS — 55×55</option>
              <option value="80x80">watchOS — 80×80</option>
              <option value="88x88">watchOS — 88×88</option>
              <option value="172x172">watchOS — 172×172</option>
              <option value="196x196">watchOS — 196×196</option>

              <!-- Android -->
              <optgroup label="App Icons — Android"></optgroup>
              <option value="36x36">Android — 36×36 (LDPI)</option>
              <option value="48x48">Android — 48×48 (MDPI)</option>
              <option value="72x72">Android — 72×72 (HDPI)</option>
              <option value="96x96">Android — 96×96 (XHDPI)</option>
              <option value="144x144">Android — 144×144 (XXHDPI)</option>
              <option value="192x192">Android — 192×192 (XXXHDPI)</option>
              <option value="512x512">Android — 512×512 (Play Store)</option>

              <!-- Packs -->
              <optgroup label="Icon Packs (ZIP)"></optgroup>
              <option value="ios-pack">iOS / iPadOS Pack (PNG)</option>
              <option value="watch-pack">watchOS Pack (PNG)</option>
              <option value="android-pack">Android Launcher Pack (PNG)</option>
              <option value="favicon-pack">Favicon Pack (PNG)</option>

              <option value="custom">Custom</option>
            </select>
          </div>

          <div class="grid grid-cols-2 gap-2" id="customDims" style="display:none;">
            <div>
              <label class="block text-sm font-medium mb-1">Width (px)</label>
              <input id="width" type="number" class="w-full border rounded-xl p-2" placeholder="e.g. 800" />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Height (px)</label>
              <input id="height" type="number" class="w-full border rounded-xl p-2" placeholder="e.g. 800" />
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Quality</label>
            <input id="quality" type="range" min="30" max="100" value="85" class="w-full" />
            <div class="text-xs text-gray-500"><span id="qualityVal">85</span>% (higher = larger file)</div>
          </div>

          <div>
            <label class="block text-sm font-medium mb-1">Format</label>
            <select id="format" class="w-full border rounded-xl p-2">
              <option value="image/jpeg">JPEG</option>
              <option value="image/webp">WebP</option>
              <option value="image/png">PNG</option>
            </select>
          </div>
        </div>

        <!-- Actions -->
        <div class="mt-4 flex flex-wrap gap-3 items-center">
          <button id="processBtn" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50" disabled>
            Resize & Compress
          </button>
          <button id="downloadAllBtn" class="px-4 py-2 rounded-xl bg-gray-900 text-white hover:bg-black disabled:opacity-50" disabled>
            Download All (ZIP)
          </button>
          <button id="iconPackBtn" class="px-4 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600 disabled:opacity-50" disabled>
            Generate Icon Pack (ZIP)
          </button>
          <span class="text-xs text-gray-500">Tip: click "Edit (Crop)" on any image to crop before processing.</span>
          <span id="limitNote" class="text-xs text-gray-500 ml-auto">Free tier: up to 5 images/session, ≤ 10MB each.</span>
        </div>

        <!-- Gallery -->
        <div id="gallery" class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </div>

      <!-- Right: info + ad + pricing -->
      <aside class="space-y-6">
        <div class="border rounded-2xl p-4">
          <h3 id="sellers" class="font-semibold">For Sellers</h3>
          <p class="text-sm text-gray-600">One-click presets for Amazon, Etsy, Shopify. Clean, square images that load fast and boost conversions.</p>
        </div>
        <div class="border rounded-2xl p-4">
          <h3 id="creators" class="font-semibold">For Creators</h3>
          <p class="text-sm text-gray-600">Perfect sizes for Instagram, TikTok, YouTube. Keep quality, cut the size, post faster.</p>
        </div>

        <!-- AdSense unit (we only push ads if plan is Free) -->
        <div id="adBox" class="border rounded-2xl p-4">
          <h3 class="font-semibold">Ad</h3>
          <ins id="adSlot" class="adsbygoogle"
               style="display:block"
               data-ad-client="ca-pub-8562223178556235"
               data-ad-slot="4386228600"
               data-ad-format="auto"
               data-full-width-responsive="true"></ins>
        </div>

        <div id="pricing" class="border rounded-2xl p-4">
          <h3 class="font-semibold">Pricing</h3>
          <ul class="text-sm text-gray-700 list-disc ml-5 mt-2">
            <li><strong>Free</strong>: 5 images, ≤10MB each, standard formats, ads.</li>
            <li><strong>Pro</strong> ($4/mo): Unlimited, bigger files, batch ZIP, WebP/PNG/HEIC*, no ads.</li>
          </ul>
          <div class="flex gap-2 mt-3">
            <button id="proBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Go Pro</button>
            <button id="portalBtn" class="px-4 py-2 rounded-xl border hidden">Manage subscription</button>
          </div>
          <p class="mt-2 text-[11px] text-gray-500">* HEIC support planned.</p>
        </div>
      </aside>
    </section>

    <!-- FAQ -->
    <section id="faq" class="mt-16">
      <h2 class="text-2xl font-bold mb-4">FAQ</h2>
      <details class="border rounded-xl p-4 mb-3">
        <summary class="font-medium cursor-pointer">Are my images uploaded to a server?</summary>
        <p class="text-sm text-gray-600 mt-2">Processing happens <strong>in your browser</strong> using HTML Canvas and Web APIs. We do not store your images.</p>
      </details>
      <details class="border rounded-xl p-4 mb-3">
        <summary class="font-medium cursor-pointer">How do I remove ads?</summary>
        <p class="text-sm text-gray-600 mt-2">Upgrade to Pro to remove ads, unlock higher limits, and batch features.</p>
      </details>
    </section>
  </main>

  <footer class="mt-16 border-t">
    <div class="max-w-6xl mx-auto px-4 py-8 text-sm text-gray-500 flex flex-wrap gap-4 items-center justify-between">
      <p>© <span id="year"></span> CropMyPic. All rights reserved.</p>
      <div class="flex gap-4">
        <a href="/privacy.html" class="hover:text-indigo-600">Privacy</a>
        <a href="/terms.html" class="hover:text-indigo-600">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Crop Modal -->
  <div id="cropModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="px-4 py-3 border-b flex items-center justify-between">
          <h3 class="font-semibold">Crop image</h3>
          <button id="cropClose" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
        </div>
        <div class="p-4">
          <div class="mb-3 flex flex-wrap gap-3 items-center">
            <label class="text-sm font-medium">Aspect ratio:</label>
            <select id="cropAspect" class="border rounded-lg p-2 text-sm">
              <option value="free">Free</option>
              <option value="1">1:1 (Square)</option>
              <option value="0.8">4:5 (Portrait)</option>
              <option value="1.7777777778">16:9 (Landscape)</option>
              <option value="0.5625">9:16 (Story)</option>
            </select>
            <button id="cropRotate" class="px-3 py-1.5 rounded-lg border text-sm">Rotate 90°</button>
            <button id="cropFlipH" class="px-3 py-1.5 rounded-lg border text-sm">Flip H</button>
            <button id="cropFlipV" class="px-3 py-1.5 rounded-lg border text-sm">Flip V</button>
          </div>
          <div class="w-full max-h-[60vh] overflow-hidden border rounded-xl bg-gray-50">
            <img id="cropImage" alt="Crop preview" class="max-w-full block">
          </div>
        </div>
        <div class="px-4 py-3 border-t flex justify-end gap-3">
          <button id="cropCancel" class="px-4 py-2 rounded-xl border">Cancel</button>
          <button id="cropApply" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Apply crop</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Elements
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const browseBtn = document.getElementById('browseBtn');
    const processBtn = document.getElementById('processBtn');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const iconPackBtn = document.getElementById('iconPackBtn');
    const gallery = document.getElementById('gallery');
    const preset = document.getElementById('preset');
    const customDims = document.getElementById('customDims');
    const widthEl = document.getElementById('width');
    const heightEl = document.getElementById('height');
    const quality = document.getElementById('quality');
    const qualityVal = document.getElementById('qualityVal');
    const format = document.getElementById('format');
    const year = document.getElementById('year');
    const portalBtn = document.getElementById('portalBtn');
    const proBtn = document.getElementById('proBtn');

    /* ------------ Plan & Limits (Free vs Pro) ------------ */
    const FREE_LIMITS = { maxFiles: 5,  maxBytes: 10 * 1024 * 1024 };
    const PRO_LIMITS  = { maxFiles: 100, maxBytes: 100 * 1024 * 1024 };

    // Detect Pro from cookie set by backend
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }
    
    function checkProStatus() {
      // Check for pro cookie first, then fallback to localStorage
      const proCookie = getCookie('cmp_pro');
      let isPro = false;
      
      if (proCookie) {
        try {
          // In a real implementation, you would verify the JWT with your server
          // For now, we'll just check if the cookie exists
          isPro = true;
          localStorage.setItem('cmp_plan', 'pro');
        } catch (e) {
          console.error('Error parsing pro cookie:', e);
        }
      } else {
        isPro = localStorage.getItem('cmp_plan') === 'pro';
      }
      
      return isPro;
    }

    let plan = checkProStatus() ? 'pro' : 'free';
    let filesQueue = [];
    let processed = [];

    function currentLimits(){ return plan === 'pro' ? PRO_LIMITS : FREE_LIMITS; }

    function applyPlanUI(){
      const adBox = document.getElementById('adBox');
      const limitNote = document.getElementById('limitNote');

      if (plan === 'pro') {
        if (adBox) adBox.style.display = 'none';
        if (limitNote) limitNote.textContent = `Pro: up to ${PRO_LIMITS.maxFiles} images/session, ≤ ${Math.round(PRO_LIMITS.maxBytes/1024/1024)}MB each.`;
        portalBtn.classList.remove('hidden');

        if (!document.getElementById('proBadge')) {
          const brand = document.querySelector('header .max-w-6xl > a');
          if (brand) {
            const b = document.createElement('span');
            b.id = 'proBadge';
            b.className = 'ml-2 text-xs px-2 py-0.5 rounded-full bg-emerald-600 text-white align-middle';
            b.textContent = 'PRO';
            brand.appendChild(b);
          }
        }
      } else {
        if (adBox) adBox.style.display = '';
        if (limitNote) limitNote.textContent = `Free tier: up to ${FREE_LIMITS.maxFiles} images/session, ≤ ${Math.round(FREE_LIMITS.maxBytes/1024/1024)}MB each.`;
        portalBtn.classList.add('hidden');
        const b = document.getElementById('proBadge'); if (b) b.remove();
        // Only push AdSense when Free
        try { (window.adsbygoogle = window.adsbygoogle || []).push({}); } catch(e){}
      }
    }

    year.textContent = new Date().getFullYear();
    applyPlanUI();

    // UI events
    quality.addEventListener('input', () => qualityVal.textContent = quality.value);
    preset.addEventListener('change', () => {
      customDims.style.display = preset.value === 'custom' ? 'grid' : 'none';
      updateIconPackAvailability();
      if (cropper) {
        let ratio = NaN;
        if (isPackValue(preset.value)) ratio = 1;
        else if (preset.value !== 'custom') {
          const [pw, ph] = preset.value.split('x').map(n => parseFloat(n));
          if (pw && ph) ratio = pw / ph;
        }
        if (!isNaN(ratio)) {
          cropAspect.value = String(ratio);
          cropper.setAspectRatio(ratio);
        } else {
          cropAspect.value = 'free';
          cropper.setAspectRatio(NaN);
        }
      }
    });

    browseBtn.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('click', () => fileInput.click());

    dropzone.addEventListener('dragover', e => { e.preventDefault(); dropzone.classList.add('border-indigo-400'); });
    dropzone.addEventListener('dragleave', () => dropzone.classList.remove('border-indigo-400'));
    dropzone.addEventListener('drop', e => { e.preventDefault(); dropzone.classList.remove('border-indigo-400'); enqueueFiles(e.dataTransfer.files); });
    fileInput.addEventListener('change', e => enqueueFiles(e.target.files));

    function isPackValue(v){ return ['ios-pack','watch-pack','android-pack','favicon-pack'].includes(v); }
    function updateIconPackAvailability(){
      iconPackBtn.disabled = !(isPackValue(preset.value) && filesQueue.length >= 1);
      if (isPackValue(preset.value)) format.value = 'image/png';
    }

    function enqueueFiles(fileList){
      const arr = Array.from(fileList);
      const limits = currentLimits();

      const currentCount = filesQueue.length;
      const allowed = Math.max(0, limits.maxFiles - currentCount);
      const toAdd = arr.slice(0, allowed);
      const rejectedCount = arr.length - toAdd.length;

      toAdd.forEach(f => {
        if (f.size > limits.maxBytes) { alert(`${f.name} is over ${Math.round(limits.maxBytes/1024/1024)}MB on your plan.`); return; }
        if (!f.type.startsWith('image/')) { alert(`${f.name} is not an image.`); return; }
        filesQueue.push(f);
      });

      if (rejectedCount > 0) { alert(`Your plan allows up to ${limits.maxFiles} images per session.`); }
      refreshGallery();
      updateIconPackAvailability();
    }

    function refreshGallery(){
      gallery.innerHTML = '';
      processed = [];
      processBtn.disabled = filesQueue.length === 0;
      downloadAllBtn.disabled = true;
      updateIconPackAvailability();

      filesQueue.forEach((file, idx) => {
        const card = document.createElement('div');
        card.className = 'border rounded-xl p-3';

        const head = document.createElement('div');
        head.className = 'flex items-center justify-between gap-2';

        const name = document.createElement('div');
        name.className = 'text-xs text-gray-600 truncate';
        name.textContent = file.name;

        const editBtn = document.createElement('button');
        editBtn.className = 'text-xs px-2 py-1 rounded-lg border hover:bg-gray-50';
        editBtn.textContent = 'Edit (Crop)';
        editBtn.addEventListener('click', () => openCropper(file, idx));

        head.appendChild(name);
        head.appendChild(editBtn);

        const img = document.createElement('img');
        img.className = 'w-full h-40 object-contain bg-gray-50 rounded-lg mt-2';
        const reader = new FileReader();
        reader.onload = e => img.src = e.target.result;
        reader.readAsDataURL(file);

        card.appendChild(head);
        card.appendChild(img);
        gallery.appendChild(card);
      });
    }

    processBtn.addEventListener('click', async () => {
      gtag('event', 'process_images', { event_category: 'engagement', event_label: 'resize_compress_clicked' });

      processed = [];
      const [w, h] = getTargetDims();
      const q = parseInt(quality.value, 10) / 100;
      const fmt = format.value;

      for (const file of filesQueue) {
        const out = await transformImage(file, w, h, q, fmt);
        processed.push(out);
      }

      renderProcessed();
      downloadAllBtn.disabled = processed.length === 0;
    });

    downloadAllBtn.addEventListener('click', async () => {
      gtag('event', 'download_zip', { event_category: 'engagement' });
      if (processed.length === 0) return;
      const zip = new JSZip();
      processed.forEach(p => { zip.file(p.filename, p.dataURL.split(',')[1], { base64: true }); });
      const blob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'cropmypic.zip'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    /* ---------------- Icon pack generation ---------------- */
    const ICON_PACKS = {
      'ios-pack': { mime: 'image/png', folder: 'ios', files: [
        {name:'20x20.png', size:20},{name:'29x29.png', size:29},{name:'40x40.png', size:40},
        {name:'50x50.png', size:50},{name:'57x57.png', size:57},{name:'58x58.png', size:58},
        {name:'72x72.png', size:72},{name:'76x76.png', size:76},{name:'80x80.png', size:80},
        {name:'87x87.png', size:87},{name:'100x100.png', size:100},{name:'114x114.png', size:114},
        {name:'120x120.png', size:120},{name:'144x144.png', size:144},{name:'152x152.png', size:152},
        {name:'167x167.png', size:167},{name:'180x180.png', size:180},
        {name:'512x512.png', size:512},{name:'1024x1024.png', size:1024}
      ]},
      'watch-pack': { mime: 'image/png', folder: 'watchos', files: [
        {name:'48x48.png', size:48},{name:'55x55.png', size:55},
        {name:'80x80.png', size:80},{name:'88x88.png', size:88},
        {name:'172x172.png', size:172},{name:'196x196.png', size:196}
      ]},
      'android-pack': { mime: 'image/png', folder: 'android', files: [
        {name:'mipmap-ldpi-36.png', size:36},{name:'mipmap-mdpi-48.png', size:48},
        {name:'mipmap-hdpi-72.png', size:72},{name:'mipmap-xhdpi-96.png', size:96},
        {name:'mipmap-xxhdpi-144.png', size:144},{name:'mipmap-xxxhdpi-192.png', size:192},
        {name:'play-store-512.png', size:512}
      ]},
      'favicon-pack': { mime: 'image/png', folder: 'favicon', files: [
        {name:'favicon-16.png', size:16},{name:'favicon-32.png', size:32},
        {name:'favicon-48.png', size:48},{name:'favicon-64.png', size:64},
        {name:'favicon-128.png', size:128},{name:'apple-touch-180.png', size:180},
        {name:'android-chrome-192.png', size:192},{name:'pwa-512.png', size:512}
      ]}
    };

    iconPackBtn.addEventListener('click', generateIconPack);

    async function generateIconPack(){
      const v = preset.value;
      const pack = ICON_PACKS[v];
      if (!pack) return alert('Choose an icon pack preset first.');
      if (filesQueue.length < 1) return alert('Add at least one image (the first image will be used).');

      const srcFile = filesQueue[0];
      const img = await imageFromFile(srcFile);
      const zip = new JSZip();

      for (const f of pack.files) {
        const canvas = drawSquareCoverToCanvas(img, f.size);
        const dataURL = canvas.toDataURL(pack.mime);
        zip.file(`${pack.folder}/${f.name}`, dataURL.split(',')[1], { base64: true });
      }

      const blob = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `${pack.folder}-icons.zip`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      gtag('event','download_icon_pack',{ pack:v });
    }

    function drawSquareCoverToCanvas(img, size){
      const s = Math.min(img.width, img.height);
      const sx = Math.floor((img.width  - s) / 2);
      const sy = Math.floor((img.height - s) / 2);
      const canvas = document.createElement('canvas');
      canvas.width = size; canvas.height = size;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, sx, sy, s, s, 0, 0, size, size);
      return canvas;
    }

    async function imageFromFile(file){
      const dataURL = await new Promise((resolve, reject) => {
        const r = new FileReader(); r.onload = e => resolve(e.target.result); r.onerror = reject; r.readAsDataURL(file);
      });
      return new Promise((resolve, reject) => {
        const img = new Image(); img.onload = () => resolve(img); img.onerror = reject; img.src = dataURL;
      });
    }

    function getTargetDims(){
      if (preset.value === 'custom') {
        const w = parseInt(widthEl.value || '0', 10);
        const h = parseInt(heightEl.value || '0', 10);
        return [Math.max(1, w), Math.max(1, h)];
      }
      const [w, h] = preset.value.split('x').map(n => parseInt(n, 10));
      return [w, h];
    }

    function extFromMime(mime){ if (mime === 'image/png') return 'png'; if (mime === 'image/webp') return 'webp'; return 'jpg'; }

    function renderProcessed(){
      gallery.innerHTML = '';
      processed.forEach(p => {
        const card = document.createElement('div');
        card.className = 'border rounded-xl p-3';
        const name = document.createElement('div');
        name.className = 'text-xs text-gray-600 truncate';
        name.textContent = p.filename + ` — ${Math.round(p.bytes/1024)} KB`;
        const img = document.createElement('img');
        img.className = 'w-full h-40 object-contain bg-gray-50 rounded-lg mt-2';
        img.src = p.dataURL;
        const actions = document.createElement('div');
        actions.className = 'mt-2 flex justify-between items-center';
        const dl = document.createElement('button');
        dl.className = 'px-3 py-1 rounded-lg bg-gray-900 text-white text-xs';
        dl.textContent = 'Download';
        dl.addEventListener('click', () => downloadDataURL(p.dataURL, p.filename));
        actions.appendChild(dl);
        card.appendChild(name); card.appendChild(img); card.appendChild(actions);
        gallery.appendChild(card);
      });
    }

    function downloadDataURL(dataURL, filename){
      const a = document.createElement('a'); a.href = dataURL; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
    }

    async function transformImage(file, targetW, targetH, quality, mime){
      const img = await fileToImage(file);
      const { w, h } = fitContain(img.width, img.height, targetW, targetH);
      const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
      const dataURL = canvas.toDataURL(mime, mime === 'image/png' ? undefined : quality);
      const bytes = approxBytesFromDataURL(dataURL, mime);
      const ext = extFromMime(mime);
      const base = file.name.replace(/\.[^.]+$/, '');
      const filename = `${base}_${w}x${h}.${ext}`;
      return { dataURL, filename, bytes };
    }

    function fitContain(srcW, srcH, maxW, maxH){
      const scale = Math.min(maxW / srcW, maxH / srcH);
      return { w: Math.max(1, Math.round(srcW * scale)), h: Math.max(1, Math.round(srcH * scale)) };
    }

    function fileToImage(file){
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => { const img = new Image(); img.onload = () => resolve(img); img.onerror = reject; img.src = e.target.result; };
        reader.onerror = reject; reader.readAsDataURL(file);
      });
    }

    function approxBytesFromDataURL(dataURL, mime){
      const prefix = `data:${mime};base64,`;
      const base64 = dataURL.startsWith(prefix) ? dataURL.slice(prefix.length) : dataURL.split(',')[1];
      return Math.ceil((base64.length * 3) / 4);
    }

    /* ---------- Stripe (serverless) ---------- */
    const STRIPE_PK = 'pk_live_51S97nuFMv56Or6XkN7DQwUkNdM5QqQNzRVh8y5YBOg618YYePYelmEEIWm3TRfg08ozILuZVXqOsHztQafRK7VZ700GpP4BSMk';
    const PRICE_ID  = 'price_1S98CQFMv56Or6Xk0SZNQOUh';
    const stripe    = Stripe(STRIPE_PK);

    proBtn.addEventListener('click', async () => {
      try {
        // Show loading state
        proBtn.classList.add('btn-loading', 'loading');
        proBtn.disabled = true;
        
        gtag('event', 'pro_cta_click', { event_category: 'monetization' });
        const resp = await fetch('/api/checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ priceId: PRICE_ID })
        });
        
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Checkout failed');
        
        // Redirect to Stripe Checkout
        window.location.href = data.url;
      } catch (err) {
        console.error('Checkout error:', err);
        alert('Unable to start checkout. Please try again.');
        
        // Reset button state
        proBtn.classList.remove('btn-loading', 'loading');
        proBtn.disabled = false;
      }
    });

    // Customer Portal
    portalBtn.addEventListener('click', async () => {
      try {
        portalBtn.classList.add('btn-loading', 'loading');
        portalBtn.disabled = true;
        
        const resp = await fetch('/api/portal', { method: 'POST' });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || 'Portal failed');
        
        window.location.href = data.url;
      } catch (e) {
        console.error('Portal error:', e);
        alert('Could not open the portal.');
        
        portalBtn.classList.remove('btn-loading', 'loading');
        portalBtn.disabled = false;
      }
    });

    // Handle basic return UX (before webhooks/cookies are wired)
    (function handleReturnFlags(){
      const qs = new URLSearchParams(location.search);
      if (qs.get('checkout') === 'success') {
        localStorage.setItem('cmp_plan', 'pro');
        plan = 'pro'; 
        applyPlanUI();
        alert('Thanks for subscribing! Pro features unlocked.');
        history.replaceState({}, '', location.pathname);
      } else if (qs.get('checkout') === 'cancelled') {
        history.replaceState({}, '', location.pathname);
      }
    })();

    /* ------- Cropper integration ------- */
    let cropper = null;
    let cropIndex = -1;
    let scaleX = 1, scaleY = 1;

    const cropModal  = document.getElementById('cropModal');
    const cropImage  = document.getElementById('cropImage');
    const cropClose  = document.getElementById('cropClose');
    const cropCancel = document.getElementById('cropCancel');
    const cropApply  = document.getElementById('cropApply');
    const cropAspect = document.getElementById('cropAspect');
    const cropRotate = document.getElementById('cropRotate');
    const cropFlipH  = document.getElementById('cropFlipH');
    const cropFlipV  = document.getElementById('cropFlipV');

    function openCropper(file, index){
      cropIndex = index; scaleX = 1; scaleY = 1;
      const reader = new FileReader();
      reader.onload = e => {
        cropImage.src = e.target.result;
        cropModal.classList.remove('hidden');

        if (cropper) { cropper.destroy(); cropper = null; }
        cropper = new Cropper(cropImage, {
          viewMode: 1, dragMode: 'move',
          aspectRatio: isPackValue(preset.value) ? 1 : NaN,
          autoCropArea: 0.9, responsive: true, background: false,
          movable: true, zoomable: true, rotatable: true, scalable: true
        });
      };
      reader.readAsDataURL(file);
    }

    function closeCropper(){
      cropModal.classList.add('hidden');
      if (cropper) { cropper.destroy(); cropper = null; }
      cropIndex = -1;
    }

    cropClose.addEventListener('click', closeCropper);
    cropCancel.addEventListener('click', closeCropper);

    cropAspect.addEventListener('change', () => { const v = cropAspect.value; cropper && cropper.setAspectRatio(v === 'free' ? NaN : Number(v)); });
    cropRotate.addEventListener('click', () => { cropper && cropper.rotate(90); });
    cropFlipH.addEventListener('click', () => { if (!cropper) return; scaleX = -scaleX; cropper.scaleX(scaleX); });
    cropFlipV.addEventListener('click', () => { if (!cropper) return; scaleY = -scaleY; cropper.scaleY(scaleY); });

    cropApply.addEventListener('click', () => {
      if (!cropper || cropIndex < 0) return;
      const mime = format.value;
      const q = parseInt(quality.value, 10) / 100;
      const canvas = cropper.getCroppedCanvas({ maxWidth: 4096, maxHeight: 4096 });
      const toBlobType = mime, toBlobQuality = (mime === 'image/png') ? undefined : q;

      canvas.toBlob((blob) => {
        const old = filesQueue[cropIndex];
        const ext = extFromMime(mime);
        const newName = old.name.replace(/\.[^.]+$/, '') + '-cropped.' + ext;
        if (!blob) { alert('Could not export cropped image. Try a different format.'); return; }
        const newFile = new File([blob], newName, { type: mime });
        filesQueue[cropIndex] = newFile;
        closeCropper(); refreshGallery(); updateIconPackAvailability();
      }, toBlobType, toBlobQuality);
    });
  </script>
</body>
</html>
