<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CropMyPic — Free Online Image Resizer & Compressor</title>
  
  <!-- Simplified version without external analytics/ads for testing -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <link href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet">
  <script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
  <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    .loading {
      opacity: 0.7;
      pointer-events: none;
    }
    .btn-loading {
      position: relative;
      color: transparent;
    }
    .btn-loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      top: 50%;
      left: 50%;
      margin: -10px 0 0 -10px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.8s ease infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-white text-gray-900">
  <header class="sticky top-0 z-10 bg-white/70 backdrop-blur border-b border-gray-100">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/" class="text-xl font-bold">Crop<span class="text-indigo-600">MyPic</span></a>
      <nav class="hidden sm:flex gap-6 text-sm">
        <a href="#sellers" class="hover:text-indigo-600">For Sellers</a>
        <a href="#creators" class="hover:text-indigo-600">For Creators</a>
        <a href="#pricing" class="hover:text-indigo-600">Pricing</a>
        <a href="#faq" class="hover:text-indigo-600">FAQ</a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-10">
    <section class="text-center mb-10">
      <h1 class="text-3xl sm:text-5xl font-extrabold leading-tight">
        Free Online Image <span class="text-indigo-600">Cropper</span>,
        <span class="text-indigo-600">Resizer</span> & <span class="text-indigo-600">Compressor</span>
      </h1>
      <p class="mt-3 text-gray-600 max-w-2xl mx-auto">
        Perfect sizes for <strong>Amazon, Etsy, Shopify</strong> and
        <strong>Instagram, TikTok, YouTube</strong>. No signup. Works in your browser.
      </p>
    </section>

    <!-- App grid -->
    <section class="grid md:grid-cols-3 gap-6 items-start">
      <!-- Left: uploader + controls -->
      <div class="md:col-span-2">
        <!-- Dropzone -->
        <div id="dropzone" class="border-2 border-dashed border-gray-200 rounded-2xl p-6 text-center hover:border-indigo-300 transition cursor-pointer">
          <input id="fileInput" type="file" accept="image/*" multiple class="hidden" />
          <div class="py-8">
            <p class="text-lg font-semibold">Drag & drop images here</p>
            <p class="text-sm text-gray-500">or click to choose files</p>
            <button id="browseBtn" class="mt-4 px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Choose Files</button>
          </div>
        </div>
      </div>

      <!-- Right: info + ad + pricing -->
      <aside class="space-y-6">
        <div id="pricing" class="border rounded-2xl p-4">
          <h3 class="font-semibold">Pricing</h3>
          <ul class="text-sm text-gray-700 list-disc ml-5 mt-2">
            <li><strong>Free</strong>: 5 images, ≤10MB each, standard formats.</li>
            <li><strong>Pro</strong> ($4/mo): Unlimited, bigger files, batch ZIP, no ads.</li>
          </ul>
          <div class="flex gap-2 mt-3">
            <button id="proBtn" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Go Pro</button>
            <button id="portalBtn" class="px-4 py-2 rounded-xl border hidden">Manage subscription</button>
          </div>
          <p id="checkoutStatus" class="mt-2 text-sm text-red-500 hidden">Checkout failed. Please try again.</p>
        </div>
      </aside>
    </section>
  </main>

  <script>
    // Elements
    const proBtn = document.getElementById('proBtn');
    const portalBtn = document.getElementById('portalBtn');
    const checkoutStatus = document.getElementById('checkoutStatus');

    /* ------------ Plan & Limits (Free vs Pro) ------------ */
    let plan = localStorage.getItem('cmp_plan') || 'free';

    function applyPlanUI(){
      if (plan === 'pro') {
        portalBtn.classList.remove('hidden');
        if (!document.getElementById('proBadge')) {
          const brand = document.querySelector('header .max-w-6xl > a');
          if (brand) {
            const b = document.createElement('span');
            b.id = 'proBadge';
            b.className = 'ml-2 text-xs px-2 py-0.5 rounded-full bg-emerald-600 text-white align-middle';
            b.textContent = 'PRO';
            brand.appendChild(b);
          }
        }
      } else {
        portalBtn.classList.add('hidden');
        const b = document.getElementById('proBadge'); 
        if (b) b.remove();
      }
    }

    applyPlanUI();

    /* ---------- Stripe Checkout Fix ---------- */
    // Use test key for demonstration - replace with your live key in production
    const STRIPE_PK = 'pk_test_51S97nuFMv56Or6Xk2A2vz6JzL8n6g7qZ6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q6Q';
    const PRICE_ID = 'price_1S98CQFMv56Or6Xk0SZNQOUh';
    
    // Initialize Stripe
    const stripe = Stripe(STRIPE_PK);
    
    // Add event listener to the Pro button
    proBtn.addEventListener('click', async () => {
      try {
        // Show loading state
        proBtn.classList.add('btn-loading', 'loading');
        proBtn.disabled = true;
        checkoutStatus.classList.add('hidden');
        
        console.log('Initiating checkout...');
        
        // Call your checkout API
        const response = await fetch('/api/checkout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ priceId: PRICE_ID }),
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Checkout failed');
        }
        
        const session = await response.json();
        console.log('Checkout session:', session);
        
        // Redirect to Stripe Checkout
        const result = await stripe.redirectToCheckout({
          sessionId: session.id,
        });
        
        if (result.error) {
          throw new Error(result.error.message);
        }
      } catch (error) {
        console.error('Checkout error:', error);
        checkoutStatus.textContent = `Checkout failed: ${error.message}`;
        checkoutStatus.classList.remove('hidden');
        
        // Reset button state
        proBtn.classList.remove('btn-loading', 'loading');
        proBtn.disabled = false;
      }
    });

    // Handle return from checkout
    const queryString = new URLSearchParams(window.location.search);
    if (queryString.get('checkout') === 'success') {
      localStorage.setItem('cmp_plan', 'pro');
      plan = 'pro';
      applyPlanUI();
      alert('Thanks for subscribing! Pro features unlocked.');
      
      // Clean URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  </script>
</body>
</html>
